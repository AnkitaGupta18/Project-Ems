"use strict";$(function(){var a,b=function(a,b){var c=0,d=0,e={},f=0,g=null,h="",i="",j=0,k=100,l=300;this.getMsg=function(){var a=[],b=D();b&&a.push("Country: "+E()+" ("+b+")");var c=F();c&&a.push("Postal code: "+c);var d=G();return d&&a.push("City: "+d),{valid:d?!0:!1,value:a.join("\n")}};var m=function(a){var b,c,d;a=a.split("\n"),a.forEach(function(a){a.match(/^Country: /)?b=H(a.replace(/Country: [^\(]+ \((.*)\)/,"$1")):a.match(/^Postal code: /)?c=H(a.replace(/Postal code: /,"")):a.match(/^City: /)&&(d=H(a.replace(/City: /,"")))}),b&&(jQuery("#countries").val(b),q(function(){jQuery("#codes").val(c),s(function(){jQuery("#cities").val(d)})}))},n=function(){g=JFCustomWidget.getWidgetSetting("customCountries")||null;var a=JFCustomWidget.getWidgetSetting("countryText")||null,b=JFCustomWidget.getWidgetSetting("codeText")||null,c=JFCustomWidget.getWidgetSetting("cityText")||null,d=JFCustomWidget.getWidgetSetting("listText")||null;if(("<empty>"==g||"All"==g||null==g)&&(g=""),"<empty>"!=a&&null!=a&&$("label[for=countries]").text(a),"<empty>"!=b&&null!=b&&$("label[for=codes]").text(b),"<empty>"!=c&&null!=c&&$("label[for=cities]").text(c),"<empty>"!=d&&null!=d&&$("#citiesButton").text(d),jQuery("#countries").on("change",q),jQuery("#citiesButton").on("click",v),z(),2==jQuery("#countries option").length){var e=jQuery("#countries option").last().val();jQuery("#countries").val(e).change(),jQuery("#countriesContainer").hide()}o(),r(),J()},o=function(){return C({action:"countryList",customCountries:g},p),!1},p=function(a){$.each(a,function(a,b){$("#countries").append($("<option>",{value:a}).text(b))}),b.value&&m(b.value)},q=function(a){jQuery("#citiesContainer, #citiesCount").hide(),jQuery("#codes, #cities").val(""),u(0),""==D()?jQuery("#codesContainer").hide():jQuery("#codesContainer").show(),"function"==typeof a&&a(),J()},r=function(){var a=(new Date).getTime();jQuery("#codes").val()!=h&&(jQuery("#citiesCount").hide(),h=jQuery("#codes").val(),j=a),h!=i&&a-j>l&&(i=h,s()),setTimeout(r,k)},s=function(a){return F().length<2?(jQuery("#citiesContainer, #citiesCount").hide(),u(0),J(),void("function"==typeof a&&a())):void C({action:"citiesCount",countryCode:D(),postalCode:F()},function(b){u(b),jQuery("#citiesCount").show(),t(),"function"==typeof a&&a()})},t=function(){return 0==f?(jQuery("#citiesContainer").hide(),jQuery("#cities").val(""),void jQuery("#citiesPlaceholder").html("").hide()):1==f?void C({action:"citiesList",countryCode:D(),postalCode:F()},function(a){jQuery("#cities").val("").hide(),jQuery("#citiesButton").hide(),jQuery("#citiesPlaceholder").html("<i>"+Object.keys(a)[0]+"</i>").show(),jQuery("#citiesContainer").show(),J()}):(jQuery("#cities, #citiesButton").show(),jQuery("#citiesPlaceholder").html("").hide(),"input"!=jQuery("#cities").prop("tagName").toLowerCase()&&(jQuery("#cities").replaceWith(jQuery('<input type="text" id="cities" />')),z()),jQuery("#citiesContainer").show(),void J())},u=function(a){return"string"==typeof a&&(a=a.replace('"',""),parseInt(a).toString()!==a)?!1:(jQuery("#citiesCount").html(a>0?"("+a+" cities)":"<i>(no cities found)</i>"),void(f=a))},v=function(){if(f>=1e3){var a="There are "+f+" cities matching this postal code.";if(a+=" Are you sure you want to show the whole list?",!confirm(a))return!1}var b=D();return b?(C({action:"citiesList",countryCode:b,postalCode:F()},w),!1):!1},w=function(a){var b=jQuery("<select>",{id:"cities",html:y(a)});jQuery("#cities").replaceWith(b),jQuery("#cities").on("change",I),jQuery("#cities").focus(),jQuery("#citiesButton").hide(),J()},x=function(a,b){var c=D(),d=F(),e=a.term,f=B(c,d,e);return f?void b(f):void C({action:"citiesAutocomplete",countryCode:c,postalCode:d,cityName:e},function(a){A(c,d,e,a),b(a)})},y=function(a){var b=Object.keys(a).sort(function(b,c){return a[b].toLowerCase()>a[c].toLowerCase()?1:-1}),c='<option value="" selected="selected"></option>';return b.forEach(function(b){c+='<option value="'+H(b)+'">'+H(a[b])+"</option>"}),c},z=function(){jQuery("#cities").autocomplete({minLength:2,source:x,open:J,change:I})},A=function(a,b,c,d){e[a]||(e[a]=[]),e[a][b]||(e[a][b]=[]),e[a][b][c]=d},B=function(a,b,c){return e[a]&&e[a][b]&&e[a][b][c]?"object"!=typeof e[a][b][c]?!1:e[a][b][c]:!1},C=function(a,b){jQuery.ajax({url:"index.php",type:"POST",dataType:"json",data:a,error:function(){alert("Error: failed to fetch data from server.")},success:b})},D=function(){return jQuery("#countries").val()},E=function(){var a=D();return a?jQuery("#countries option[value="+a+"]").text():""},F=function(){return jQuery("#codes").val()},G=function(){var a=jQuery("#citiesPlaceholder").text();return a?a:jQuery("#cities").val()},H=function(a){return a.replace(/\r/,"").replace(/^[\t\n ]+/g,"").replace(/[\t\n ]+$/g,"")},I=function(){JFCustomWidget&&JFCustomWidget.sendData({value:G()})},J=function(){if(JFCustomWidget){var a=jQuery("body").width(),b=jQuery("body").height();"block"==jQuery(".ui-autocomplete").css("display")&&(b+=jQuery(".ui-autocomplete").height()),(a!=c||b!=d)&&(JFCustomWidget.requestFrameResize({width:a+16,height:b+10}),c=a,d=b)}};n()};JFCustomWidget.subscribe("ready",function(c){a=new b(JFCustomWidget.getWidgetSettings(),c),JFCustomWidget.subscribe("submit",function(){JFCustomWidget.sendSubmit(a.getMsg())})})});